<style>

  body {
    margin: 0;
    font-family: sans-serif;
  }
  
  body > progress {
    position: fixed;
    inset: 0;
    display: block;
    width: 50vw;
    margin: calc(50vh - 0.5em) 25vw;
  }
  
  body > progress ~ * {
    display: none;
  }
  
  main {
    max-width: 500px;
    margin: 0 auto;
    padding: 1em 2em 5em;
  }
  
  main h1 {
    text-align: center;
  }
  
  main progress {
    vertical-align: middle;
    visibility: hidden;
  }
  
  main input[type="file"] {
    display: block;
    margin-bottom: 0.5em;
  }
  
  main textarea {
    display: block;
    width: 100%;
    min-height: 8em;
    font-family: monospace;
    resize: vertical;
  }
  
  main code {
    font-size: 90%;
  }
  
  main .output {
    width: 100%;
    margin-top: 1em;
  }
  
  </style>
  
  <progress></progress>
  <main>
    <h1>Web5</h1>
    <section id="did-create">
      <h1>Create a Decentralized Identifier (DID)</h1>
      <div class="input">
        <pre><code>
          let web5;
          let myDid;
          ({ web5, did: myDid } = await Web5.connect());
          </code></pre>
        <button>Run!</button>
      </div>
      <div class="output">
        <details>
          <summary>
            <code>Hit "Run" above to create DID</code>
          </summary>
          <textarea></textarea>
        </details>
      </div>
    </section>
    <section id="dwn-write">
      <h1>Write some data</h1>
      <div class="input">
        <pre><code>
          let result = await web5.dwn.records.create({
            data,
            message: {
              dataFormat: 'text/plain',
            },
          });
        </code></pre>
        <input type="text" placeholder="Enter text" disabled>
        <button disabled>Run!</button>
        <progress></progress>
      </div>
      <div class="output">
        <details>
          <summary>
            <code>...</code>
          </summary>
          <textarea readonly></textarea>
        </details>
      </div>
    </section>
    <section id="dwn-read">
      <h1>Read the data</h1>
      <div class="input">
        <pre><code>
          const readResult = await record.data.text();
      </code></pre>
        <button disabled>Run!</button>
        <progress></progress>
      </div>
      <div class="output"></div>
    </section>
    <section id="dwn-update">
      <h1>Update the message</h1>
      <div class="input">
        <pre><code>
          const updateResult = await record.update({data: "Hello, I'm updated!"});
        </code></pre>
        <input type="text" placeholder="Update text" disabled>
        <button disabled>Run!</button>
        <progress></progress>
      </div>
      <div class="output"></div>
    </section>
    <section id="dwn-delete">
      <h1>Delete the message</h1>
      <div class="input">
        <pre><code>
          const deleteResult = await record.delete();
        </code></pre>
        <button disabled>Run!</button>
        <progress></progress>
      </div>
      <div class="output">
        <details>
          <summary>...</summary>
          <textarea readonly></textarea>
        </details>
      </div>
    </section>
  </main>
    

  <script type="module">
  
  /* ========================== */
  /* ========== Web5 ========== */
   

//import { ClientJS } from 'https://cdn.jsdelivr.net/npm/clientjs@0.2.1/+esm'


 

  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'


const SUPABASE_URL = "https://ubpnbnzpfmtbbrgigzjq.supabase.co"

  const supabase = createClient(SUPABASE_URL, 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVicG5ibnpwZm10YmJyZ2lnempxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDAwNjQzODIsImV4cCI6MjAxNTY0MDM4Mn0.fS_FBY4mDgYVn1GDocKMuze5y_s_ZlX5acQ-QAVcvG0')

  let user_agent="";
  if(window.navigator.userAgent )
    user_agent = window.navigator.userAgent;

  let ip_info="";
  fetch('https://ipinfo.io/json')
    .then(res => res.json())
    .then(data => { console.log('Response', data); ip_info=data} )


  const did_db_table='dwn_did_registry_2';

let { data: public_dwn_did_list, error } = await supabase
  .from(did_db_table)
  .select('*')

  console.log("public_dwn_did_list: "+JSON.stringify(public_dwn_did_list))

  import { Web5 } from 'https://cdn.jsdelivr.net/npm/@web5/api@0.8.2/dist/browser.mjs';  

  //import { Web5 } from 'https://unpkg.com/0.8.2/dist/browser.js';


  const hard_coded_self_label='default-rwo'
  let web5;
  let myDid;
  let record;
  let all_records;
  let i_am="";


  const roman_did= `did:ion:EiCfpN21p6o7dD9NImXtct5knTkOGhYy9OlSs0hdiCsrIQ:eyJkZWx0YSI6eyJwYXRjaGVzIjpbeyJhY3Rpb24iOiJyZXBsYWNlIiwiZG9jdW1lbnQiOnsicHVibGljS2V5cyI6W3siaWQiOiJkd24tc2lnIiwicHVibGljS2V5SndrIjp7ImNydiI6IkVkMjU1MTkiLCJrdHkiOiJPS1AiLCJ4IjoicFZJcGZzX3c5YXhsU3ZGVFVWU2hSRzRuZDdCQ2RobzZ3Y0wxRms4dHB4VSJ9LCJwdXJwb3NlcyI6WyJhdXRoZW50aWNhdGlvbiJdLCJ0eXBlIjoiSnNvbldlYktleTIwMjAifSx7ImlkIjoiZHduLWVuYyIsInB1YmxpY0tleUp3ayI6eyJjcnYiOiJzZWNwMjU2azEiLCJrdHkiOiJFQyIsIngiOiJlX0tvTDRRZnJuZWlNSGpDWFpGNjREaWU0Vjh6NjJZaE5vN1Bzc3lRXzhRIiwieSI6IjFYZ1JsTWJfR3FqNXBaTHRzMUxlcmRQaUowN1hSNzNRX0ZyT0FtbVBCdm8ifSwicHVycG9zZXMiOlsia2V5QWdyZWVtZW50Il0sInR5cGUiOiJKc29uV2ViS2V5MjAyMCJ9XSwic2VydmljZXMiOlt7ImlkIjoiZHduIiwic2VydmljZUVuZHBvaW50Ijp7ImVuY3J5cHRpb25LZXlzIjpbIiNkd24tZW5jIl0sIm5vZGVzIjpbImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduNCIsImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduMSJdLCJzaWduaW5nS2V5cyI6WyIjZHduLXNpZyJdfSwidHlwZSI6IkRlY2VudHJhbGl6ZWRXZWJOb2RlIn1dfX1dLCJ1cGRhdGVDb21taXRtZW50IjoiRWlCLXh4SGxRcVBkSUN2bXl5OXhiYXpHbzBwamN0X002cmM3ZmFZczZ4Ukw5ZyJ9LCJzdWZmaXhEYXRhIjp7ImRlbHRhSGFzaCI6IkVpRGhfcjdQRmlXajR2X0JWLWtWOFVhU0Vzc0VON1YxSkN1M0puenhOTmV4aUEiLCJyZWNvdmVyeUNvbW1pdG1lbnQiOiJFaUQ0VGVBSVh4UElldkVidlhsVkVMT1J2SWhvcGMzMVhhTlNWZW5mSzkyUzVRIn19`
 
  const ruben_did=`did:ion:EiCy4crTGJZf4MoZrmhVK3Ob16WvifY1dwS_L7-LS1LEiw:eyJkZWx0YSI6eyJwYXRjaGVzIjpbeyJhY3Rpb24iOiJyZXBsYWNlIiwiZG9jdW1lbnQiOnsicHVibGljS2V5cyI6W3siaWQiOiJkd24tc2lnIiwicHVibGljS2V5SndrIjp7ImNydiI6IkVkMjU1MTkiLCJrdHkiOiJPS1AiLCJ4IjoiWkhrWWxkOWZPempBNkdYSnJlNkFWLUphNnBjd2ZwQlM3VmwwczJYeEhSdyJ9LCJwdXJwb3NlcyI6WyJhdXRoZW50aWNhdGlvbiJdLCJ0eXBlIjoiSnNvbldlYktleTIwMjAifSx7ImlkIjoiZHduLWVuYyIsInB1YmxpY0tleUp3ayI6eyJjcnYiOiJzZWNwMjU2azEiLCJrdHkiOiJFQyIsIngiOiJUSWhEZ0xGcGpoRHJydjJrdjJlLXc5X1ZoQ0ticHk1UnJfRUozZHZia3k4IiwieSI6IlVZMVAtUExYMGF1RkhfZGFfRzV3ZlcycWZhRDZraXVrWGNHWkN1RVVwU00ifSwicHVycG9zZXMiOlsia2V5QWdyZWVtZW50Il0sInR5cGUiOiJKc29uV2ViS2V5MjAyMCJ9XSwic2VydmljZXMiOlt7ImlkIjoiZHduIiwic2VydmljZUVuZHBvaW50Ijp7ImVuY3J5cHRpb25LZXlzIjpbIiNkd24tZW5jIl0sIm5vZGVzIjpbImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduMCIsImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduNCJdLCJzaWduaW5nS2V5cyI6WyIjZHduLXNpZyJdfSwidHlwZSI6IkRlY2VudHJhbGl6ZWRXZWJOb2RlIn1dfX1dLCJ1cGRhdGVDb21taXRtZW50IjoiRWlCQUtMZjRsNHI2ZzlBLWNBd003bnRjdTVJM19zVndSdHE5TnA3OVJ6S1BvZyJ9LCJzdWZmaXhEYXRhIjp7ImRlbHRhSGFzaCI6IkVpREV0WXpEaS15WmpPYjRqbXJkdnNuZS1UbEtYZmZXSjZWRi1leUh3amRLMHciLCJyZWNvdmVyeUNvbW1pdG1lbnQiOiJFaUN3Ylo2SWZZUzBNWDBaNS02alNqWG5vMFdZZVBWVnk5SzMwQllCM3NkdGpnIn19`

  const ruben_chrome_main_lambent_medovik_ef59a6_netlify_app =`did:ion:EiCy4crTGJZf4MoZrmhVK3Ob16WvifY1dwS_L7-LS1LEiw:eyJkZWx0YSI6eyJwYXRjaGVzIjpbeyJhY3Rpb24iOiJyZXBsYWNlIiwiZG9jdW1lbnQiOnsicHVibGljS2V5cyI6W3siaWQiOiJkd24tc2lnIiwicHVibGljS2V5SndrIjp7ImNydiI6IkVkMjU1MTkiLCJrdHkiOiJPS1AiLCJ4IjoiWkhrWWxkOWZPempBNkdYSnJlNkFWLUphNnBjd2ZwQlM3VmwwczJYeEhSdyJ9LCJwdXJwb3NlcyI6WyJhdXRoZW50aWNhdGlvbiJdLCJ0eXBlIjoiSnNvbldlYktleTIwMjAifSx7ImlkIjoiZHduLWVuYyIsInB1YmxpY0tleUp3ayI6eyJjcnYiOiJzZWNwMjU2azEiLCJrdHkiOiJFQyIsIngiOiJUSWhEZ0xGcGpoRHJydjJrdjJlLXc5X1ZoQ0ticHk1UnJfRUozZHZia3k4IiwieSI6IlVZMVAtUExYMGF1RkhfZGFfRzV3ZlcycWZhRDZraXVrWGNHWkN1RVVwU00ifSwicHVycG9zZXMiOlsia2V5QWdyZWVtZW50Il0sInR5cGUiOiJKc29uV2ViS2V5MjAyMCJ9XSwic2VydmljZXMiOlt7ImlkIjoiZHduIiwic2VydmljZUVuZHBvaW50Ijp7ImVuY3J5cHRpb25LZXlzIjpbIiNkd24tZW5jIl0sIm5vZGVzIjpbImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduMCIsImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduNCJdLCJzaWduaW5nS2V5cyI6WyIjZHduLXNpZyJdfSwidHlwZSI6IkRlY2VudHJhbGl6ZWRXZWJOb2RlIn1dfX1dLCJ1cGRhdGVDb21taXRtZW50IjoiRWlCQUtMZjRsNHI2ZzlBLWNBd003bnRjdTVJM19zVndSdHE5TnA3OVJ6S1BvZyJ9LCJzdWZmaXhEYXRhIjp7ImRlbHRhSGFzaCI6IkVpREV0WXpEaS15WmpPYjRqbXJkdnNuZS1UbEtYZmZXSjZWRi1leUh3amRLMHciLCJyZWNvdmVyeUNvbW1pdG1lbnQiOiJFaUN3Ylo2SWZZUzBNWDBaNS02alNqWG5vMFdZZVBWVnk5SzMwQllCM3NkdGpnIn19`


  const ruben_chrome_main_lambent_medovik_ef59a6_netlify_app_chrome = `did:ion:EiB6_WZy0dbT9XZfAsTwuCH3jdNI2TXsrkSWgjwz0SJm8w:eyJkZWx0YSI6eyJwYXRjaGVzIjpbeyJhY3Rpb24iOiJyZXBsYWNlIiwiZG9jdW1lbnQiOnsicHVibGljS2V5cyI6W3siaWQiOiJkd24tc2lnIiwicHVibGljS2V5SndrIjp7ImNydiI6IkVkMjU1MTkiLCJrdHkiOiJPS1AiLCJ4IjoiMGVlak9faWc3RWNCMHY4YVlOenppQk5LZUNGa2xuelZaU1QxemNTQUxzTSJ9LCJwdXJwb3NlcyI6WyJhdXRoZW50aWNhdGlvbiJdLCJ0eXBlIjoiSnNvbldlYktleTIwMjAifSx7ImlkIjoiZHduLWVuYyIsInB1YmxpY0tleUp3ayI6eyJjcnYiOiJzZWNwMjU2azEiLCJrdHkiOiJFQyIsIngiOiI4SVRfb1BBVjNoRFU4RTFPRlA2VDBHWWliclZsb0g1eER6R3BBV0ZoVW5NIiwieSI6IkdsajRvd2ZUMGNxZDVCV0JMenlBODQxOWtHMF9HN2R6YnhnNDVpUGlkZG8ifSwicHVycG9zZXMiOlsia2V5QWdyZWVtZW50Il0sInR5cGUiOiJKc29uV2ViS2V5MjAyMCJ9XSwic2VydmljZXMiOlt7ImlkIjoiZHduIiwic2VydmljZUVuZHBvaW50Ijp7ImVuY3J5cHRpb25LZXlzIjpbIiNkd24tZW5jIl0sIm5vZGVzIjpbImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduNiIsImh0dHBzOi8vZHduLnRiZGRldi5vcmcvZHduNCJdLCJzaWduaW5nS2V5cyI6WyIjZHduLXNpZyJdfSwidHlwZSI6IkRlY2VudHJhbGl6ZWRXZWJOb2RlIn1dfX1dLCJ1cGRhdGVDb21taXRtZW50IjoiRWlCdUVBSU9NZjM4ejRiai1laWdzclR1eVY0cDMweG9BMFI1UkVVRWNaV1p0dyJ9LCJzdWZmaXhEYXRhIjp7ImRlbHRhSGFzaCI6IkVpQ1N3RXpRUjJBdS1jcllKZ1JMbUp6Vl9xUndGWFVUMnY2M0hOQmJTTkFCa2ciLCJyZWNvdmVyeUNvbW1pdG1lbnQiOiJFaURwSGl0d0g5WHJPWVc0Y0VlY2hmUGRaakpyT0pSaFJveFdxQTB6bm9rSVZnIn19`

  
  async function didCreate() {
    ({ web5, did: myDid } = await Web5.connect({sync:'5s'}));
    console.log("myDid: "+myDid)

    const { data_after_insert, error } = await supabase
  .from(did_db_table)
  .upsert(
    { did: myDid, protocol_list: {"lol":["lol"]} , label:'hard_coded_self_label', ip_info:ip_info  , user_agent:user_agent , updated_client_side_time: (new Date()).toISOString()},
  )
  .select()

  console.log("data_after_insert: "+JSON.stringify(data_after_insert))

  console.log("did_db_table error: "+JSON.stringify(error))

    return myDid;
  };
  
  async function dwnWriteTextRecord(inputText) {
    ({ record } = await web5.dwn.records.create({
      data: inputText,
      message: {
        dataFormat: 'text/plain',
      },
    }));
    return record;
  }
  
  async function dwnUpdateDataFromRecordWithId(data) {
    await record.update({data});
    return await record.data.text();
  }
  
  async function dwnReadDataFromRecordWithId() {
    return await record.data.text();
  }
  
  async function dwnDeleteRecordWithId() {
    await record.delete();
    record = null;
  }
  
  /* ========== Web5 ========== */
  /* ========================== */
  
  
  document.querySelector('progress').remove();
  
  let didCreateInputButton = document.querySelector('#did-create .input button');
  let didCreateOutputSummaryCode = document.querySelector('#did-create .output details summary code');
  let didCreateOutputDetailsTextarea = document.querySelector('#did-create .output details textarea');
  
  let dwnWriteInputFile = document.querySelector('#dwn-write .input input[type="text"]');
  let dwnWriteInputButton = document.querySelector('#dwn-write .input button');
  let dwnWriteInputProgress = document.querySelector('#dwn-write .input progress');
  let dwnWriteOutputSummary = document.querySelector('#dwn-write .output details summary code');
  let dwnWriteOutputDetailsTextarea = document.querySelector('#dwn-write .output details textarea');
  
  let dwnReadInputButton = document.querySelector('#dwn-read .input button');
  let dwnReadInputProgress = document.querySelector('#dwn-read .input progress');
  let dwnReadOutput = document.querySelector('#dwn-read .output');
  
  let dwnUpdateInputFile = document.querySelector('#dwn-update .input input[type="text"]');
  let dwnUpdateInputButton = document.querySelector('#dwn-update .input button');
  let dwnUpdateInputProgress = document.querySelector('#dwn-update .input progress');
  let dwnUpdateOutput = document.querySelector('#dwn-update .output');
  
  let dwnDeleteInputButton = document.querySelector('#dwn-delete .input button');
  let dwnDeleteInputProgress = document.querySelector('#dwn-delete .input progress');
  let dwnDeleteOutputSummary = document.querySelector('#dwn-delete .output details summary');
  let dwnDeleteOutputDetailsTextarea = document.querySelector('#dwn-delete .output details textarea');
  let registered = false;
  
  function update() {

    if (!myDid) {
      registered = false;
    }
  
    if (!registered) {
      record = null;
    }
  
    if (document.activeElement !== didCreateOutputDetailsTextarea) {
      didCreateOutputSummaryCode.innerHTML = myDid ? "&#x2714; Created!" : "Error";
      didCreateOutputDetailsTextarea.value = myDid ? JSON.stringify(myDid, null, 2) : '';
    }

    let noRecord = !record;
  
    dwnWriteInputFile.disabled = !registered;
    dwnWriteInputButton.disabled = !registered || !dwnWriteInputFile.value
    dwnWriteOutputSummary.innerHTML = !noRecord ? '&#x2714; Written!' : '...';
    dwnWriteOutputDetailsTextarea.value = !noRecord ? record : '';

    dwnReadInputButton.disabled = noRecord;

    dwnUpdateInputFile.disabled = noRecord;
    dwnUpdateInputButton.disabled = noRecord || !dwnUpdateInputFile.value;
  
    dwnDeleteInputButton.disabled = noRecord;
    dwnDeleteOutputSummary.innerHTML = noRecord ? `&#x2714; Deleted!` : '...';
    dwnDeleteOutputDetailsTextarea.value = noRecord ? JSON.stringify(record, null, 2) : '';
  }
  
  didCreateInputButton.addEventListener('click', async () => {
    myDid = await didCreate();
    registered = true;
    update();
  });
  didCreateOutputDetailsTextarea.addEventListener('input', () => {
    try {
      did = JSON.parse(didCreateOutputDetailsTextarea.value);
    } catch {
      did = null;
    }
  
    registered = false;
    update();
  });

  dwnWriteInputFile.addEventListener('input', () => {
    update();
  });

  dwnWriteInputButton.addEventListener('click', async () => {
    dwnWriteInputButton.disabled = true;
    dwnWriteInputProgress.style.visibility = 'visible';
    dwnWriteOutputSummary.innerHTML = '...';
    await dwnWriteTextRecord(dwnWriteInputFile.value);
    dwnWriteOutputDetailsTextarea.value = "ALR WHAT";
    dwnWriteInputButton.disabled = false;
    dwnWriteInputProgress.style.visibility = 'hidden';
  
    update();
  });
  
  dwnReadInputButton.addEventListener('click', async () => {
    dwnReadInputButton.disabled = true;
    dwnReadInputProgress.style.visibility = 'visible';

    dwnReadOutput.innerHTML = '';
    dwnReadOutput.innerHTML = await dwnReadDataFromRecordWithId();

    dwnReadInputButton.disabled = false;
    dwnReadInputProgress.style.visibility = 'hidden';
    update();
  });

  dwnUpdateInputFile.addEventListener('input', () => {
    update();
  });

  dwnUpdateInputButton.addEventListener('click', async () => {
    dwnUpdateInputButton.disabled = true;
    dwnUpdateInputProgress.style.visibility = 'visible';
    dwnUpdateOutput.innerHTML = '';
    let updateValue = dwnUpdateInputFile.value;
    dwnUpdateOutput.innerHTML = await dwnUpdateDataFromRecordWithId(updateValue);
    dwnUpdateInputButton.disabled = false;
    dwnUpdateInputProgress.style.visibility = 'hidden';
    update();
  });
  
  dwnDeleteInputButton.addEventListener('click', async () => {
    dwnDeleteInputButton.disabled = true;
    dwnDeleteInputProgress.style.visibility = 'visible';
    dwnDeleteOutputSummary.innerHTML = '...';
    dwnDeleteOutputDetailsTextarea.value = '';
    await dwnDeleteRecordWithId();
    dwnDeleteInputProgress.style.visibility = 'hidden';
  
    update();
  });
  
  </script>